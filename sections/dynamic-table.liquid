{%- comment -%}
  This section displays a dynamic comparison table.
  
  !! FIX: Corrected missing '| color_to_css' filter.
  !! This was the error breaking the background color.
  
  !! MOBILE FIX: Added 'width: 100%' and 'box-sizing' to the
  !! content wrapper to fix the mobile overflow and enable scrolling.
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign heading_text_alignment = 'text-align: ' | append: s.heading_text_alignment | append: ';'

  # Get all column header blocks
  assign column_blocks = section.blocks | where: 'type', 'column_header'
  # Get all table row blocks
  assign row_blocks = section.blocks | where: 'type', 'table_row'

  # Create an inline style to FORCE the background color
  assign section_styles = ''
  if s.color_scheme != blank and s.color_scheme.settings.background
    # THIS IS THE FIX: Added the '| color_to_css' filter
    assign bg_color = s.color_scheme.settings.background 
    assign section_styles = 'background-color: ' | append: bg_color | append: ';'
  endif
-%}

{%- comment -%}
  CSS for the section
{%- endcomment -%}
{%- style -%}
  /* ---
    LAYOUT STYLES
    Copied from 'Image with Text Carousel'
  --- */
  .dynamic-table-section-{{ section.id }} {
    padding: 50px 0; /* Vertical padding for the section */
  }

  /* This class must be here for the full-width toggle */
  .section--full-width {
    width: 100vw;
    margin-left: calc( (100% - 100vw) / 2 );
  }

  /* This wrapper centers the content and adds horizontal padding */
  .dynamic-table-content-wrapper {
    padding: 40px;
    max-width: 1536px; /* Max width of the content */
    margin-left: auto;
    margin-right: auto;
    
    /* MOBILE OVERFLOW FIX: */
    width: 100%;
    box-sizing: border-box; 
  }

  @media (max-width: 768px) {
    .dynamic-table-section-{{ section.id }} {
      padding: 30px 0; /* Adjust vertical padding for mobile */
    }
    .dynamic-table-content-wrapper {
      padding: 0 20px; /* Adjust horizontal padding for mobile */
    }
  }
  /* --- End of layout styles --- */


  /* --- Section Specific CSS --- */
  .dynamic-table-section-{{ section.id }} .section-heading {
    margin-bottom: 2.5rem; /* 40px */
  }

  .dynamic-table-section-{{ section.id }} .table-scroll-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    border: 1px solid var(--color-border, #e5e5e5);
    border-radius: 8px;
    margin: 0 auto;
    max-width: 100%; 
  }

  .dynamic-table-section-{{ section.id }} .spec-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px; 
  }

  .dynamic-table-section-{{ section.id }} .spec-table th,
  .dynamic-table-section-{{ section.id }} .spec-table td {
    padding: 0.875rem 1rem; /* 14px 16px */
    border: 1px solid var(--color-border, #e5e5e5);
    text-align: left;
    vertical-align: middle;
    white-space: nowrap; /* Prevents text from wrapping */
    background-color: transparent; /* This lets the section BG show through */
  }

  .dynamic-table-section-{{ section.id }} .spec-table thead th {
    font-weight: 600;
  }

  .dynamic-table-section-{{ section.id }} .spec-table thead th:first-child {
    font-weight: 700;
    min-width: 200px;
    white-space: normal;
  }
  
  .dynamic-table-section-{{ section.id }} .spec-table tbody td:first-child {
    font-weight: 600;
    white-space: normal;
  }

  .dynamic-table-section-{{ section.id }} .spec-table td[data-icon] {
    text-align: center;
  }

  .dynamic-table-section-{{ section.id }} .icon-check {
    width: 20px;
    height: 20px;
    stroke: green;
    stroke-width: 2.5;
  }
  
  .dynamic-table-section-{{ section.id }} .icon-cross {
    width: 20px;
    height: 20px;
    stroke: red;
    stroke-width: 2.5;
  }
{%- endstyle -%}

{%- comment -%}
  SVG definitions for the icons
{%- endcomment -%}
<svg style="display: none;">
  <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <polyline points="20 6 9 17 4 12"></polyline>
  </symbol>
  <symbol id="icon-cross" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <line x1="18" y1="6" x2="6" y2="18"></line>
    <line x1="6" y1="6" x2="18" y2="18"></line>
  </symbol>
</svg>

<div
  class="dynamic-table-section-{{ section.id }} section {% if s.full_width %}section--full-width{% endif %}"
  style="{{ section_styles }}"
>
  <div class="dynamic-table-content-wrapper">
    
    {%- if s.heading != blank -%}
      <h2 class="section-heading h2" style="{{ heading_text_alignment }}">
        {{ s.heading | escape }}
      </h2>
    {%- endif -%}

    {%- if section.blocks.size > 0 -%}
      <div class="table-scroll-wrapper">
        <table class="spec-table">
          <thead>
            <tr>
              <th>{{ s.first_column_title | escape }}</th>
              
              {%- for block in column_blocks -%}
                <th {{ block.shopify_attributes }}>
                  {{ block.settings.title | escape }}
                </th>
              {%- endfor -%}
            </tr>
          </thead>
          <tbody>
            {%- for block in row_blocks -%}
              <tr {{ block.shopify_attributes }}>
                <td>{{ block.settings.spec_title | escape }}</td>
                
                {%- assign cells = block.settings.row_data | split: '|' -%}

                {%- for cell in cells -%}
                  {%- assign cell_content = cell | strip | downcase -%}

                  {%- if cell_content == 'tick' or cell_content == 'yes' or cell_content == 'check' -%}
                    <td data-icon="check">
                      <svg class="icon-check" aria-hidden="true" focusable="false"><use href="#icon-check" /></svg>
                    </td>
                  {%- elsif cell_content == 'cross' or cell_content == 'no' or cell_content == 'x' -%}
                    <td data-icon="cross">
                      <svg class="icon-cross" aria-hidden="true" focusable="false"><use href="#icon-cross" /></svg>
                    </td>
                  {%- else -%}
                    <td>{{ cell | strip }}</td>
                  {%- endif -%}
                {%- endfor -%}
              </tr>
            {%- endfor -%}
          </tbody>
        </table>
      </div>
    {%- endif -%}

  </div> </div>

{% schema %}
{
  "name": "Dynamic Table",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Make section full width",
      "default": true
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Specifications"
    },
    {
      "type": "select",
      "id": "heading_text_alignment",
      "label": "Heading Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "text",
      "id": "first_column_title",
      "label": "First Column Title",
      "default": "Specifications"
    }
  ],
  "blocks": [
    {
      "type": "column_header",
      "name": "Column Header",
      "limit": 5,
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Column Title",
          "default": "Column"
        }
      ]
    },
    {
      "type": "table_row",
      "name": "Table Row",
      "limit": 50,
      "settings": [
        {
          "type": "text",
          "id": "spec_title",
          "label": "Specification Name",
          "default": "Density"
        },
        {
          "type": "text",
          "id": "row_data",
          "label": "Row Data",
          "info": "Separate data for each column with a pipe (|). Use 'tick' or 'cross' for icons. Example: `Value 1 | tick | cross | Value 4`"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Dynamic Table",
      "blocks": [
        { "type": "column_header", "settings": { "title": "S-OSB" } },
        { "type": "column_header", "settings": { "title": "Plywood" } },
        { "type": "column_header", "settings": { "title": "HDF" } },
        { 
          "type": "table_row", 
          "settings": { 
            "spec_title": "Density(in Lb/m3)", 
            "row_data": "1545 - 1655 | 1435 - 1545 | 1545 - 1655" 
          } 
        },
        { 
          "type": "table_row", 
          "settings": { 
            "spec_title": "Prelam Option", 
            "row_data": "tick | cross | tick" 
          } 
        },
        { 
          "type": "table_row", 
          "settings": { 
            "spec_title": "Duco Paint", 
            "row_data": "tick | cross | tick" 
          } 
        }
      ]
    }
  ]
}
{% endschema %}