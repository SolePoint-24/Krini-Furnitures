{% comment %}
  Section: Product Comparison Table
  This section is dynamically filled by JavaScript based on
  product handles stored in localStorage.
  
  REFACTORED to use a <table> for proper alignment.
{% endcomment %}

<style>
  .compare-page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: var(--font-body-family);
  }

  .compare-scroll-wrapper {
    width: 100%;
    overflow-x: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-top: 20px;
  }

  /* ▼▼▼ MODIFICATION: Switched to <table> layout ▼▼▼ */
  .compare-table {
    width: 100%;
    min-width: max-content; /* Allows table to grow horizontally */
    border-collapse: collapse; /* Clean borders */
    table-layout: fixed; /* Ensures columns are respected */
  }

  .compare-table th,
  .compare-table td {
    padding: 16px;
    border: 1px solid #e0e0e0;
    vertical-align: middle; /* ▼▼▼ MODIFICATION: Default to middle alignment ▼▼▼ */
    height: 1px; /* Allows cells to shrink or grow */
  }

  /* Label Column (First Column, using <th>) */
  .compare-table th.compare-label-cell {
    width: 150px; /* ▼▼▼ MODIFICATION: Reduced width from 200px ▼▼▼ */
    background-color: #f9f9f9;
    font-weight: 600;
    position: sticky; /* Sticks the labels on the left */
    left: 0;
    z-index: 10;
    text-align: left;
    font-size: 1.1em;
  }

  /* Product Columns (using <td>) */
  .compare-table td.compare-product-cell {
    width: 300px; /* Width of each product column */
    text-align: center;
  }
  
  /* Make header cells taller */
  .compare-table thead th,
  .compare-table thead td {
    height: 140px; /* ▼▼▼ MODIFICATION: Reduced height from 180px ▼▼▼ */
    vertical-align: middle;
  }

  /* Specific row heights for remove button */
  .compare-table tr:first-child th,
  .compare-table tr:first-child td {
    height: 80px;
  }
  
  /* ▲▲▲ End of <table> layout modifications ▲▲▲ */
  
  /* ▼▼▼ NEW RULE: Force description row to top-align ▼▼▼ */
  .compare-table .compare-row--description th,
  .compare-table .compare-row--description td {
    vertical-align: top;
  }
  /* ▲▲▲ End of New Rule ▲▲▲ */


  /* ▼▼▼ NEW: Mobile Responsive ▼▼▼ */
  @media (max-width: 768px) {
    /* Hide the label column on mobile */
    .compare-table th.compare-label-cell {
      display: none;
    }
  }
  /* ▲▲▲ End of New Rule ▲▲▲ */


  /* Cell Content Styles */
  .compare-cell .remove-button {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
  }
  .compare-cell .remove-button:hover {
    background: #c0392b;
  }
  
  .compare-cell img {
    width: 100%;
    height: auto;
    max-width: 200px;
    margin: 0 auto;
    border-radius: 4px;
  }
  
  .compare-cell h3 {
    font-size: 1.1em;
    margin: 0;
  }
  
  .compare-cell .price {
    font-size: 1.2em;
    font-weight: 600;
    color: #513117;
  }
  
  .compare-cell .atc-button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1em;
    text-decoration: none;
    text-align: center;
  }
  .compare-cell .atc-button:hover {
    background: #45a049;
  }
  
  .compare-cell .availability {
    font-weight: 600;
  }
  .compare-cell .availability.in-stock {
    color: #27ae60;
  }
  .compare-cell .availability.out-of-stock {
    color: #e74c3c;
  }

  .compare-cell .description {
    font-size: 0.9em;
    line-height: 1.6;
    /* ▼▼▼ MODIFICATION: Aligned left, scrollbar removed ▼▼▼ */
    text-align: left; 
    /* No max-height or overflow */
    /* ▲▲▲ End of Modification ▲▲▲ */
  }

  /* Empty/Loading States */
  .compare-empty-message,
  .compare-loading-message {
    text-align: center;
    font-size: 1.2em;
    padding: 40px;
    color: #555;
  }
</style>

<div class="compare-page-container page-width">
  <div id="compare-scroll-wrapper" class="compare-scroll-wrapper">
    <div class="compare-loading-message">
      Loading products...
    </div>
    
    <!-- ▼▼▼ MODIFICATION: Switched from <div> to <table> ▼▼▼ -->
    <table id="compare-table" class="compare-table" style="display: none;">
      <!-- JavaScript will build the table here -->
    </table>
    <!-- ▲▲▲ End of Modification ▲▲▲ -->

  </div>
  
  <div id="compare-empty-message" class="compare-empty-message" style="display: none;">
    You haven't added any products to compare yet.
    <a href="/collections/all" style="margin-top: 10px; display: block;">Continue Shopping</a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const COMPARE_LIST_KEY = 'compareList';
    
    const SHOP_LOCALE = '{{ shop.locale | default: 'en' }}';
    const SHOP_CURRENCY = {{ shop.currency | json }};

    const tableContainer = document.getElementById('compare-table');
    const loadingMessage = document.querySelector('.compare-loading-message');
    const emptyMessage = document.getElementById('compare-empty-message');
    const scrollWrapper = document.getElementById('compare-scroll-wrapper');
    
    const handles = JSON.parse(localStorage.getItem(COMPARE_LIST_KEY)) || [];

    if (handles.length === 0) {
      scrollWrapper.style.display = 'none';
      emptyMessage.style.display = 'block';
      loadingMessage.style.display = 'none';
      return;
    }

    // --- 1. Fetch all product data ---
    const requests = handles.map(handle => {
      return fetch(`/products/${handle}.js`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Could not fetch product: ${handle}`);
          }
          return response.json();
        })
        .catch(error => {
          console.warn(error);
          return null; 
        });
    });

    Promise.all(requests)
      .then(products => {
        const validProducts = products.filter(p => p !== null);
        if (validProducts.length > 0) {
          buildCompareTable(validProducts);
          tableContainer.style.display = 'table'; // Changed from 'flex'
        } else {
          scrollWrapper.style.display = 'none';
          emptyMessage.style.display = 'block';
        }
        loadingMessage.style.display = 'none';
      });

    // --- 2. Build the HTML table (REFACTORED) ---
    function buildCompareTable(products) {
      // Create Table Head (thead) for top content
      const thead = document.createElement('thead');
      
      // --- Row 1: Remove Button ---
      const rowRemove = document.createElement('tr');
      rowRemove.appendChild(document.createElement('th')).className = 'compare-label-cell'; // Empty label
      products.forEach(product => {
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = `<button class="remove-button" data-handle="${product.handle}">Remove</button>`;
        rowRemove.appendChild(cell);
      });
      thead.appendChild(rowRemove);

      // --- Row 2: Image ---
      const rowImage = document.createElement('tr');
      rowImage.innerHTML = '<th class="compare-label-cell">Product</th>'; // Label
      products.forEach(product => {
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = `<img src="${product.featured_image ? product.featured_image.replace(/(\.[^.]*)$/, '_300x$1') : ''}" alt="${product.title}" loading="lazy">`;
        rowImage.appendChild(cell);
      });
      thead.appendChild(rowImage);

      // --- Row 3: Title ---
      const rowTitle = document.createElement('tr');
      rowTitle.innerHTML = '<th class="compare-label-cell">Title</th>'; // Label
      products.forEach(product => {
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = `<h3>${product.title}</h3>`;
        rowTitle.appendChild(cell);
      });
      thead.appendChild(rowTitle);

      // --- Row 4: Price ---
      const rowPrice = document.createElement('tr');
      rowPrice.innerHTML = '<th class="compare-label-cell">Price</th>'; // Label
      products.forEach(product => {
        const price = new Intl.NumberFormat(SHOP_LOCALE, {
          style: 'currency',
          currency: SHOP_CURRENCY
        }).format(product.price / 100.0);
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = `<span class="price">${price}</span>`;
        rowPrice.appendChild(cell);
      });
      thead.appendChild(rowPrice);

      // --- Row 5: Add to Cart ---
      const rowATC = document.createElement('tr');
      rowATC.appendChild(document.createElement('th')).className = 'compare-label-cell'; // Empty label
      products.forEach(product => {
        const variantId = product.variants[0].id;
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = `<a href="/cart/add?id=${variantId}" class="atc-button">Add to Cart</a>`;
        rowATC.appendChild(cell);
      });
      thead.appendChild(rowATC);

      // Create Table Body (tbody) for attributes
      const tbody = document.createElement('tbody');

      // --- Row 6: Availability ---
      const rowAvailability = document.createElement('tr');
      rowAvailability.innerHTML = '<th class="compare-label-cell">Availability</th>'; // Label
      products.forEach(product => {
        const availability = product.available
          ? '<span class="availability in-stock">✓ In stock</span>'
          : '<span class="availability out-of-stock">X Out of stock</span>';
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = availability;
        rowAvailability.appendChild(cell);
      });
      tbody.appendChild(rowAvailability);

      // --- Row 7: Description ---
      const rowDescription = document.createElement('tr');
      rowDescription.className = 'compare-row--description'; /* ▼▼▼ MODIFICATION: Added class for CSS ▼▼▼ */
      rowDescription.innerHTML = '<th class="compare-label-cell">Description</th>'; // Label
      products.forEach(product => {
        const cell = document.createElement('td');
        cell.className = 'compare-product-cell compare-cell';
        cell.innerHTML = `<div class="description">${product.description}</div>`;
        rowDescription.appendChild(cell);
      });
      tbody.appendChild(rowDescription);
      
      // Append new structure to the table
      tableContainer.innerHTML = ''; // Clear any old content
      tableContainer.appendChild(thead);
      tableContainer.appendChild(tbody);
      
      // Add event listeners to the new "Remove" buttons
      addRemoveListeners();
    }

    // --- 3. Add "Remove" button logic ---
    function addRemoveListeners() {
      tableContainer.querySelectorAll('.remove-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const handleToRemove = e.target.dataset.handle;
          
          let compareList = JSON.parse(localStorage.getItem(COMPARE_LIST_KEY)) || [];
          compareList = compareList.filter(h => h !== handleToRemove);
          localStorage.setItem(COMPARE_LIST_KEY, JSON.stringify(compareList));
          
          window.location.reload();
        });
      });
    }
  });
</script>

{% schema %}
{
  "name": "Compare Page",
  "tag": "section",
  "class": "compare-page-section",
  "presets": [
    {
      "name": "Compare Page"
    }
  ]
}
{% endschema %}

