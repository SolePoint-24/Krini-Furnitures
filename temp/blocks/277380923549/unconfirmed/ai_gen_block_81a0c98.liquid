{% doc %}
  @prompt
    Create a Liquid section named 'Catalog Download Modal'. The section should display a 'Get Catalog' button that opens a centered modal popup.
    
    Settings Requirements:
    
    A 'PDF File' URL picker for the catalog.
    
    A 'Custom HTML/App Embed' textarea setting to paste code from the Shopify Forms app.
    
    Text settings for headings and descriptions.
    
    Logic & Flow:
    
    If the 'Custom HTML' setting is filled, render that code inside the modal.
    
    If 'Custom HTML' is empty, render a native Shopify Contact form with fields: Name, Email, Mobile, Company.
    
    Crucial Feature: Inside the modal, below the form, always display a secondary button labeled 'Skip & Download PDF'. This allows users to download the file immediately without filling the form if they choose not to.
    
    If using the native form, ensure successful submission tags the customer with 'catalog-download' and then reveals the download button.
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-catalog-modal-trigger-{{ ai_gen_id }} {
    display: inline-block;
    padding: 16px 32px;
    background-color: {{ block.settings.button_bg_color }};
    color: {{ block.settings.button_text_color }};
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: {{ block.settings.button_font_size }}px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .ai-catalog-modal-trigger-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.button_hover_bg_color }};
    color: {{ block.settings.button_hover_text_color }};
  }

  .ai-catalog-modal-overlay-{{ ai_gen_id }} {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .ai-catalog-modal-overlay-{{ ai_gen_id }}.active {
    opacity: 1;
    visibility: visible;
  }

  .ai-catalog-modal-container-{{ ai_gen_id }} {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%;
    max-width: {{ block.settings.modal_max_width }}px;
    max-height: 90vh;
    background-color: {{ block.settings.modal_bg_color }};
    border-radius: {{ block.settings.modal_border_radius }}px;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .ai-catalog-modal-container-{{ ai_gen_id }}.active {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
  }

  .ai-catalog-modal-header-{{ ai_gen_id }} {
    padding: 24px;
    border-bottom: 1px solid {{ block.settings.modal_border_color }};
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .ai-catalog-modal-title-{{ ai_gen_id }} {
    margin: 0;
    color: {{ block.settings.modal_text_color }};
    font-size: {{ block.settings.modal_heading_size }}px;
  }

  .ai-catalog-modal-close-{{ ai_gen_id }} {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: {{ block.settings.modal_text_color }};
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .ai-catalog-modal-close-{{ ai_gen_id }}:hover {
    opacity: 1;
  }

  .ai-catalog-modal-body-{{ ai_gen_id }} {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  .ai-catalog-modal-description-{{ ai_gen_id }} {
    color: {{ block.settings.modal_text_color }};
    margin-bottom: 24px;
    font-size: 14px;
    line-height: 1.6;
  }

  .ai-catalog-form-{{ ai_gen_id }} .field {
    margin-bottom: 16px;
  }

  .ai-catalog-form-{{ ai_gen_id }} label {
    display: block;
    margin-bottom: 8px;
    color: {{ block.settings.modal_text_color }};
    font-size: 14px;
    font-weight: 500;
  }

  .ai-catalog-form-{{ ai_gen_id }} input,
  .ai-catalog-form-{{ ai_gen_id }} textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid {{ block.settings.input_border_color }};
    border-radius: {{ block.settings.input_border_radius }}px;
    font-size: 14px;
    background-color: {{ block.settings.input_bg_color }};
    color: {{ block.settings.modal_text_color }};
  }

  .ai-catalog-form-{{ ai_gen_id }} input:focus,
  .ai-catalog-form-{{ ai_gen_id }} textarea:focus {
    outline: none;
    border-color: {{ block.settings.button_bg_color }};
  }

  .ai-catalog-form-submit-{{ ai_gen_id }} {
    width: 100%;
    padding: 14px 24px;
    background-color: {{ block.settings.button_bg_color }};
    color: {{ block.settings.button_text_color }};
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 8px;
  }

  .ai-catalog-form-submit-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.button_hover_bg_color }};
    color: {{ block.settings.button_hover_text_color }};
  }

  .ai-catalog-skip-button-{{ ai_gen_id }} {
    width: 100%;
    padding: 14px 24px;
    background-color: transparent;
    color: {{ block.settings.modal_text_color }};
    border: 1px solid {{ block.settings.modal_text_color }};
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 16px;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }

  .ai-catalog-skip-button-{{ ai_gen_id }}:hover {
    background-color: {{ block.settings.modal_text_color }};
    color: {{ block.settings.modal_bg_color }};
  }

  .ai-catalog-success-message-{{ ai_gen_id }} {
    padding: 16px;
    background-color: #d4edda;
    color: #155724;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
  }

  .ai-catalog-error-message-{{ ai_gen_id }} {
    padding: 16px;
    background-color: #f8d7da;
    color: #721c24;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
  }

  .ai-catalog-download-button-{{ ai_gen_id }} {
    width: 100%;
    padding: 14px 24px;
    background-color: #28a745;
    color: #ffffff;
    border: none;
    border-radius: {{ block.settings.button_border_radius }}px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }

  .ai-catalog-download-button-{{ ai_gen_id }}:hover {
    background-color: #218838;
  }

  .ai-catalog-custom-html-{{ ai_gen_id }} {
    margin-bottom: 24px;
  }

  @media screen and (max-width: 749px) {
    .ai-catalog-modal-container-{{ ai_gen_id }} {
      width: 95%;
      max-height: 85vh;
    }

    .ai-catalog-modal-header-{{ ai_gen_id }},
    .ai-catalog-modal-body-{{ ai_gen_id }} {
      padding: 16px;
    }

    .ai-catalog-modal-title-{{ ai_gen_id }} {
      font-size: {{ block.settings.modal_heading_size | times: 0.8 }}px;
    }
  }
{% endstyle %}

<catalog-download-modal-{{ ai_gen_id }} {{ block.shopify_attributes }}>
  <button
    class="ai-catalog-modal-trigger-{{ ai_gen_id }}"
    aria-label="{{ block.settings.button_text }}"
  >
    {{ block.settings.button_text }}
  </button>

  <div class="ai-catalog-modal-overlay-{{ ai_gen_id }}"></div>

  <div class="ai-catalog-modal-container-{{ ai_gen_id }}">
    <div class="ai-catalog-modal-header-{{ ai_gen_id }}">
      <h2 class="ai-catalog-modal-title-{{ ai_gen_id }}">{{ block.settings.modal_heading }}</h2>
      <button
        class="ai-catalog-modal-close-{{ ai_gen_id }}"
        aria-label="Close modal"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="ai-catalog-modal-body-{{ ai_gen_id }}">
      {% if block.settings.modal_description != blank %}
        <div class="ai-catalog-modal-description-{{ ai_gen_id }}">
          {{ block.settings.modal_description }}
        </div>
      {% endif %}

      {% if block.settings.custom_html != blank %}
        <div class="ai-catalog-custom-html-{{ ai_gen_id }}">
          {{ block.settings.custom_html }}
        </div>
      {% else %}
        {% form 'contact', class: 'ai-catalog-form-' | append: ai_gen_id %}
          <input type="hidden" name="contact[catalog_download]" value="true">

          {% if form.posted_successfully? %}
            <div class="ai-catalog-success-message-{{ ai_gen_id }}">
              {{ block.settings.success_message }}
            </div>
            {% if block.settings.pdf_url != blank %}
              <a
                href="{{ block.settings.pdf_url }}"
                class="ai-catalog-download-button-{{ ai_gen_id }}"
                download
                target="_blank"
              >
                {{ block.settings.download_button_text }}
              </a>
            {% endif %}
          {% else %}
            {% if form.errors %}
              <div class="ai-catalog-error-message-{{ ai_gen_id }}">
                {{ form.errors | default_errors }}
              </div>
            {% endif %}

            <div class="field">
              <label for="catalog-name-{{ ai_gen_id }}">Name *</label>
              <input
                type="text"
                id="catalog-name-{{ ai_gen_id }}"
                name="contact[name]"
                required
                autocomplete="name"
              >
            </div>

            <div class="field">
              <label for="catalog-email-{{ ai_gen_id }}">Email *</label>
              <input
                type="email"
                id="catalog-email-{{ ai_gen_id }}"
                name="contact[email]"
                required
                autocomplete="email"
              >
            </div>

            <div class="field">
              <label for="catalog-phone-{{ ai_gen_id }}">Mobile</label>
              <input
                type="tel"
                id="catalog-phone-{{ ai_gen_id }}"
                name="contact[phone]"
                autocomplete="tel"
              >
            </div>

            <div class="field">
              <label for="catalog-company-{{ ai_gen_id }}">Company</label>
              <input
                type="text"
                id="catalog-company-{{ ai_gen_id }}"
                name="contact[company]"
                autocomplete="organization"
              >
            </div>

            <button type="submit" class="ai-catalog-form-submit-{{ ai_gen_id }}">
              {{ block.settings.submit_button_text }}
            </button>
          {% endif %}
        {% endform %}
      {% endif %}

      {% if block.settings.pdf_url != blank %}
        <a
          href="{{ block.settings.pdf_url }}"
          class="ai-catalog-skip-button-{{ ai_gen_id }}"
          download
          target="_blank"
        >
          {{ block.settings.skip_button_text }}
        </a>
      {% endif %}
    </div>
  </div>
</catalog-download-modal-{{ ai_gen_id }}>

<script>
  (function() {
    class CatalogDownloadModal{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
      }

      connectedCallback() {
        this.trigger = this.querySelector('.ai-catalog-modal-trigger-{{ ai_gen_id }}');
        this.overlay = this.querySelector('.ai-catalog-modal-overlay-{{ ai_gen_id }}');
        this.modal = this.querySelector('.ai-catalog-modal-container-{{ ai_gen_id }}');
        this.closeButton = this.querySelector('.ai-catalog-modal-close-{{ ai_gen_id }}');

        this.setupEventListeners();
      }

      setupEventListeners() {
        this.trigger.addEventListener('click', () => this.openModal());
        this.closeButton.addEventListener('click', () => this.closeModal());
        this.overlay.addEventListener('click', () => this.closeModal());

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.modal.classList.contains('active')) {
            this.closeModal();
          }
        });
      }

      openModal() {
        this.overlay.classList.add('active');
        this.modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      closeModal() {
        this.overlay.classList.remove('active');
        this.modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    customElements.define('catalog-download-modal-{{ ai_gen_id }}', CatalogDownloadModal{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Catalog download modal",
  "settings": [
    {
      "type": "header",
      "content": "Trigger button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Get Catalog"
    },
    {
      "type": "range",
      "id": "button_font_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Font size",
      "default": 16
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "label": "Border radius",
      "default": 8
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Background color",
      "default": "#c3cca6"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Text color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_hover_bg_color",
      "label": "Hover background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_hover_text_color",
      "label": "Hover text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Modal content"
    },
    {
      "type": "text",
      "id": "modal_heading",
      "label": "Heading",
      "default": "Download Our Catalog"
    },
    {
      "type": "range",
      "id": "modal_heading_size",
      "min": 16,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Heading size",
      "default": 24
    },
    {
      "type": "richtext",
      "id": "modal_description",
      "label": "Description",
      "default": "<p>Fill out the form below to receive our latest catalog.</p>"
    },
    {
      "type": "url",
      "id": "pdf_url",
      "label": "PDF file URL"
    },
    {
      "type": "textarea",
      "id": "custom_html",
      "label": "Custom HTML/App embed"
    },
    {
      "type": "header",
      "content": "Form settings"
    },
    {
      "type": "text",
      "id": "submit_button_text",
      "label": "Submit button text",
      "default": "Submit & Download"
    },
    {
      "type": "text",
      "id": "skip_button_text",
      "label": "Skip button text",
      "default": "Skip & Download PDF"
    },
    {
      "type": "text",
      "id": "download_button_text",
      "label": "Download button text",
      "default": "Download Catalog"
    },
    {
      "type": "richtext",
      "id": "success_message",
      "label": "Success message",
      "default": "<p>Thank you! Your request has been submitted successfully.</p>"
    },
    {
      "type": "header",
      "content": "Modal style"
    },
    {
      "type": "range",
      "id": "modal_max_width",
      "min": 400,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Maximum width",
      "default": 600
    },
    {
      "type": "range",
      "id": "modal_border_radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Border radius",
      "default": 12
    },
    {
      "type": "color",
      "id": "modal_bg_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "modal_text_color",
      "label": "Text color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "modal_border_color",
      "label": "Border color",
      "default": "#e6e6e6"
    },
    {
      "type": "header",
      "content": "Input fields"
    },
    {
      "type": "range",
      "id": "input_border_radius",
      "min": 0,
      "max": 16,
      "step": 1,
      "unit": "px",
      "label": "Border radius",
      "default": 8
    },
    {
      "type": "color",
      "id": "input_bg_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "input_border_color",
      "label": "Border color",
      "default": "#e6e6e6"
    }
  ],
  "presets": [
    {
      "name": "Catalog download modal"
    }
  ]
}
{% endschema %}
